# Supabase Database Schema for MyCommunityPortal

This file documents the tables created in Supabase for the MyCommunityPortal project.

## Tables

### 1. profiles
Purpose: Stores user profile information linked to Supabase Auth users.

Columns:
- id (UUID, Primary Key, References auth.users(id)): Unique identifier matching the auth user.
- first_name (TEXT): User's first name.
- last_name (TEXT): User's last name.
- email (TEXT): User's email address.
- phone (TEXT): User's phone number.
- street_address (TEXT): User's street address.
- region (TEXT): User's region.
- province (TEXT): User's province.
- municipality (TEXT): User's municipality/city.
- barangay (TEXT): User's barangay.
- zip_code (TEXT): User's ZIP code.
- role (TEXT): User's role (e.g., Resident, Collector, City Official).

SQL to create the table:
```sql
CREATE TABLE profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  first_name TEXT,
  last_name TEXT,
  email TEXT,
  phone TEXT,
  street_address TEXT,
  region TEXT,
  province TEXT,
  municipality TEXT,
  barangay TEXT,
  zip_code TEXT,
  role TEXT
);
```

Enable Row Level Security:
```sql
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
```

Create Policies (copy and paste each one separately into the SQL Editor):

```sql
CREATE POLICY "Users can view own profile" ON profiles
FOR SELECT USING (auth.uid() = id);
```

```sql
CREATE POLICY "Users can insert own profile" ON profiles
FOR INSERT WITH CHECK (auth.uid() = id);
```

```sql
CREATE POLICY "Users can update own profile" ON profiles
FOR UPDATE USING (auth.uid() = id);
```

Note: These policies ensure that users can only access and modify their own profile data, providing security and privacy.

-- Function to create a public.profiles entry
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email)
  VALUES (new.id, new.email);
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger the function every time a user is created
CREATE OR REPLACE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE PROCEDURE public.handle_new_user();

### 2. reports
Purpose: Stores user-submitted issue reports.

Columns:
- id (UUID, Primary Key, Default value: uuid_generate_v4()): Unique identifier for the report.
- user_id (UUID, Foreign Key, References public.profiles(id)): ID of the user who submitted the report.
- issue_type (TEXT): Type of issue being reported (e.g., illegal-dumping, missed-collection).
- priority (TEXT): Priority level of the report (e.g., low, medium, high).
- location (TEXT): Location of the issue.
- municipality (TEXT): Municipality where the issue is located.
- description (TEXT): Detailed description of the issue.
- files (JSONB): Array of URLs to uploaded photos.
- created_at (TIMESTAMP WITH TIME ZONE, Default value: now()): Timestamp of when the report was created.
- status (TEXT, Default value: 'pending'): Current status of the report (e.g., pending, under-review, in-progress, resolved).

SQL to create the table:
```sql
CREATE TABLE reports (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES public.profiles(id),
  issue_type TEXT,
  priority TEXT,
  location TEXT,
  municipality TEXT,
  description TEXT,
  files JSONB,
  created_at TIMESTAMPTZ DEFAULT now(),
  status TEXT DEFAULT 'pending'
);
```

Enable Row Level Security:
```sql
ALTER TABLE reports ENABLE ROW LEVEL SECURITY;
```

Create Policies (copy and paste each one separately into the SQL Editor):

```sql
CREATE POLICY "Users can view own reports" ON reports
FOR SELECT USING (auth.uid() = user_id);
```

```sql
CREATE POLICY "Users can insert own reports" ON reports
FOR INSERT WITH CHECK (auth.uid() = user_id);
```

```sql
CREATE POLICY "Users can update own reports" ON reports
FOR UPDATE USING (auth.uid() = user_id);
```

```sql
CREATE POLICY "Admins can view reports in their municipality" ON reports
FOR SELECT USING (
  EXISTS (
    SELECT 1
    FROM profiles
    WHERE
      profiles.id = auth.uid() AND
      profiles.role = 'admin' AND
      profiles.municipality = reports.municipality
  )
);
```
